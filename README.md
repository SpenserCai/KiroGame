# 👻 小鬼消消乐 - Ghost Match Game

一款基于 PixiJS v8.14.0 的浏览器消除类益智游戏。

## 🎮 游戏简介

小鬼消消乐是一款经典的三消游戏，玩家通过交换相邻的小鬼图标来形成三个或更多相同图标的连线，从而消除它们并获得分数。游戏采用模块化架构设计，使用 PixiJS 作为渲染引擎，确保代码解耦、可扩展且易于维护。

## ✨ 功能特性（项目已完成）

### 核心玩法
- ✅ 8x8 游戏板显示
- ✅ 5 种不同的小鬼图标
- ✅ 点击选中图标（高亮边框 + 脉冲动画）
- ✅ 点击相邻图标进行交换
- ✅ 自动检测匹配（3连或更多）
- ✅ 无匹配时自动交换回原位置
- ✅ 悬停效果
- ✅ 响应式布局（自适应不同屏幕尺寸）

### 游戏逻辑
- ✅ 完整的游戏状态管理（MENU、PLAYING、PAUSED、GAME_OVER、ANIMATING）
- ✅ 交换-匹配-消除-下落-填充循环
- ✅ 自动连锁反应检测
- ✅ 精确的分数计算系统
  - 基础分数：每个图标10分
  - 连锁倍数：1.5 ^ (comboCount - 1)
  - 4连额外20分，5连额外50分
- ✅ 图标自动下落填充
- ✅ 无可用移动检测（优化版本，带缓存）
- ✅ 自动洗牌机制（无可用移动时）
- ✅ 游戏结束判定（时间到 / 无可用移动）

### 特殊图标系统
- ✅ 4种特殊图标类型
  - 💣 炸弹（4连生成）：消除周围3x3范围
  - 🌈 彩色炸弹（5连生成）：消除所有同色图标
  - ➡️ 横向消除（L/T型生成）：消除整行
  - ⬇️ 纵向消除（L/T型生成）：消除整列
- ✅ 特殊图标组合效果
  - 炸弹 + 炸弹 = 5x5范围爆炸
  - 炸弹 + 横向/纵向消除 = 3行或3列消除
  - 彩色炸弹 + 任何特殊图标 = 超级爆炸
- ✅ 额外分数奖励（2-5倍）

### 粒子效果系统
- ✅ 消除爆炸效果（25个粒子，颜色匹配图标）
- ✅ 连锁特效（彩虹色螺旋扩散，粒子数随连锁增加）
- ✅ 特殊图标激活效果
  - 炸弹：橙红色火焰爆炸（60个粒子）
  - 彩色炸弹：全屏彩色粒子雨（120个粒子）
  - 横向/纵向消除：蓝白色光束（40个粒子）
- ✅ 对象池优化（减少GC压力）
- ✅ 基于物理的粒子运动（速度、加速度、重力）

### 动画系统
- ✅ 轻量级补间动画系统（9种缓动函数）
- ✅ 交换动画（200ms, 平滑移动）
- ✅ 消除动画（300ms, 缩放 + 淡出）
- ✅ 下落动画（400ms, 模拟重力）
- ✅ 生成动画（200ms, 弹跳效果）
- ✅ 选中动画（循环脉冲）
- ✅ 连锁动画序列
- ✅ 60 FPS 流畅运行

### UI 系统
- ✅ 开始菜单（"小鬼消消乐"标题 + 开始按钮）
- ✅ 暂停菜单（继续游戏 / 重新开始）
- ✅ 游戏结束界面（最终分数 + 移动次数 + 重新开始）
- ✅ 实时分数显示（左上角）
- ✅ 倒计时器显示（右上角，<10秒红色警告）
- ✅ 移动次数显示（左上角下方）
- ✅ 暂停按钮（顶部中央，带悬停效果）
- ✅ FPS 显示（可选，调试模式）

### 游戏循环
- ✅ 基于 PixiJS Ticker 的游戏主循环
- ✅ 每帧更新动画和游戏逻辑
- ✅ 计时系统（默认60秒倒计时）
- ✅ 暂停/恢复功能（ESC 键或按钮）
- ✅ 重新开始功能
- ✅ 性能监控（FPS 显示）

### 错误处理与优化
- ✅ 统一的错误处理机制（7种错误类型）
- ✅ WebGL上下文丢失恢复
- ✅ 友好的错误提示UI
- ✅ 实时性能监控（FPS、内存、帧时间）
- ✅ 对象池优化（补间动画、粒子系统）
- ✅ 配置验证功能

## 🚀 快速开始

### 环境要求

- Node.js 18.x 或更高版本
- npm 或 yarn

### 安装依赖

```bash
npm install
```

### 生成游戏资源

**重要：** 由于图片文件不会被上传到 git，首次运行前需要生成图标资源：

```bash
npm run build:assets
```

这将扫描 `assets/svg/` 目录下的所有 SVG 文件，并转换为 128x128 的 PNG 文件，保存到 `assets/images/` 目录。

### 启动开发服务器

```bash
npm run dev
```

访问 http://localhost:5173 即可开始游戏。

### 构建生产版本

```bash
npm run build
```

构建结果将输出到 `dist` 目录。

### 预览生产版本

```bash
npm run preview
```

## 🎨 美术资源

### SVG 转 PNG

游戏使用 SVG 作为源文件，通过 sharp 库自动转换为 PNG：

```bash
npm run build:assets
```

这将扫描 `assets/svg/` 目录下的所有 SVG 文件，并转换为 128x128 的 PNG 文件，保存到 `assets/images/` 目录。

**注意：** 由于 `.gitignore` 配置，生成的 PNG 文件不会被提交到 git。克隆项目后需要先运行 `npm run build:assets` 生成图标资源。

### 图标列表

**普通小鬼图标**:
- 红色小鬼 (ghost-red)
- 蓝色小鬼 (ghost-blue)
- 黄色小鬼 (ghost-yellow)
- 绿色小鬼 (ghost-green)
- 紫色小鬼 (ghost-purple)

**特殊图标**:
- 💣 炸弹 (bomb)
- 🌈 彩色炸弹 (color-bomb)
- ➡️ 横向消除 (row-clear)
- ⬇️ 纵向消除 (col-clear)

## 🧪 测试

### 运行单元测试

```bash
npm test
```

### 监听模式

```bash
npm run test:watch
```

### 测试覆盖率

当前测试覆盖率：
- EventBus: 100% (8/8 测试通过)
- BoardManager: 100% (9/9 测试通过)
- MatchDetector: 100% (8/8 测试通过)
- GameEngine: 100% (7/7 测试通过)
- StateManager: 100% (9/9 测试通过)
- SpecialTileManager: 100% (10/10 测试通过)
- Tween: 100% (8/8 测试通过)
- ErrorHandler: 100% (19/19 测试通过)
- PerformanceMonitor: 100% (11/11 测试通过)
- Particle: 100% (9/9 测试通过)
- ParticleEmitter: 100% (9/9 测试通过)
- ParticleEffects: 100% (14/14 测试通过)
- 集成测试: 100% (11/11 测试通过)
- **总计: 130/130 测试通过 ✅**

## 📁 项目结构

```
ghost-match-game/
├── index.html              # 游戏入口页面
├── package.json            # 项目配置
├── vite.config.js          # Vite 配置
├── README.md               # 项目说明
├── scripts/
│   └── convert-svg.js      # SVG 转 PNG 脚本
├── src/
│   ├── main.js            # 游戏主入口
│   ├── config.js          # 游戏配置
│   ├── core/
│   │   ├── EventBus.js    # 事件总线
│   │   ├── StateManager.js # 状态管理器
│   │   └── GameEngine.js  # 游戏引擎
│   ├── game/
│   │   ├── Tile.js        # 图标类
│   │   ├── BoardManager.js # 游戏板管理器
│   │   ├── MatchDetector.js # 匹配检测器
│   │   └── SpecialTileManager.js # 特殊图标管理器
│   ├── rendering/
│   │   ├── RenderEngine.js        # 渲染引擎
│   │   ├── TileTextureFactory.js  # 纹理工厂
│   │   ├── Particle.js            # 粒子类
│   │   ├── ParticleEmitter.js     # 粒子发射器
│   │   └── ParticleEffects.js     # 粒子效果管理器
│   ├── input/
│   │   └── InputManager.js        # 输入管理器
│   ├── animation/
│   │   ├── Easing.js      # 缓动函数
│   │   ├── Tween.js       # 补间动画类
│   │   └── AnimationController.js # 动画控制器
│   └── utils/
│       ├── ErrorHandler.js        # 错误处理器
│       └── PerformanceMonitor.js  # 性能监控器
├── assets/
│   ├── svg/               # SVG 源文件
│   │   ├── ghosts/       # 普通小鬼图标 SVG
│   │   └── special/      # 特殊图标 SVG
│   └── images/            # PNG 资源（不提交到 git）
│       ├── ghosts/       # 普通小鬼图标 PNG
│       └── special/      # 特殊图标 PNG
├── tests/
│   ├── integration.test.js  # 集成测试
│   └── unit/
│       ├── EventBus.test.js
│       ├── BoardManager.test.js
│       ├── MatchDetector.test.js
│       ├── GameEngine.test.js
│       ├── StateManager.test.js
│       ├── SpecialTileManager.test.js
│       ├── Tween.test.js
│       ├── ErrorHandler.test.js
│       ├── PerformanceMonitor.test.js
│       ├── Particle.test.js
│       ├── ParticleEmitter.test.js
│       └── ParticleEffects.test.js
└── dev_docs/              # 开发文档
    ├── phases/           # 各阶段完成报告
    └── bug_fix/          # Bug 修复记录
```

## 🛠️ 技术栈

- **渲染引擎**: PixiJS v8.14.0
- **开发工具**: Vite v5.0
- **包管理**: npm
- **图像处理**: sharp v0.33.0
- **测试框架**: Node.js 内置 test runner
- **编程语言**: JavaScript (ES6+ Modules)

## 📋 开发进度

### ✅ 第一阶段：基础架构和核心数据结构
- ✅ 项目结构和配置
- ✅ 事件总线系统
- ✅ 图标和游戏板数据结构
- ✅ 匹配检测算法

### ✅ 第二阶段：美术资源准备和 PixiJS 渲染引擎
- ✅ 设计和生成图标资源
- ✅ 实现 PixiJS 渲染引擎基础
- ✅ 实现图标纹理加载和精灵系统
- ✅ 实现输入管理器

### ✅ 第三阶段：游戏循环和核心逻辑
- ✅ 实现状态管理器
- ✅ 实现游戏引擎核心逻辑
- ✅ 实现消除和分数系统
- ✅ 实现下落和填充机制

### ✅ 第四阶段：动画系统
- ✅ 实现补间动画系统
- ✅ 实现动画控制器
- ✅ 集成动画到游戏流程

### ✅ 第五阶段：UI 和游戏循环
- ✅ 实现游戏主循环（基于 PixiJS Ticker）
- ✅ 实现 UI 渲染（分数、计时器、移动次数、按钮）
- ✅ 实现菜单和暂停功能（开始菜单、暂停菜单、ESC 键）

### ✅ 第六阶段：计时系统和特殊图标
- ✅ 实现计时系统（60秒倒计时，<10秒红色警告）
- ✅ 实现特殊图标系统（4种特殊图标 + 组合效果）
- ✅ 实现可用移动检测和洗牌（智能检测 + 自动洗牌）
- ✅ 实现游戏结束界面（时间到 / 无可用移动）
- ✅ 实现响应式布局（自适应屏幕尺寸）

### ✅ 第七阶段：优化和完善
- ✅ 实现错误处理（7种错误类型 + 自动恢复）
- ✅ 实现性能监控和优化（FPS、内存、对象池）
- ✅ 编写单元测试（130个测试用例，100%通过）
- ✅ 编写集成测试（11个测试用例，100%通过）

### ✅ 第八阶段：测试和打磨
- ✅ 游戏平衡性调整
- ✅ 添加粒子效果（消除爆炸、连锁特效、特殊图标效果）
- ✅ 多轮游戏测试
- ✅ 性能优化和代码质量提升

**项目状态：已完成 🎉**

## 🎯 游戏特色

- 🎨 基于 PixiJS v8.14.0 的高性能渲染
- 🎬 流畅的动画系统（60 FPS）
- 💥 震撼的粒子效果系统（消除爆炸、连锁特效、特殊图标效果）
- 🎮 完整的游戏循环和状态管理
- ⏱️ 60秒倒计时挑战模式
- � 连应锁反应系统（分数倍增）
- 💣 4种特殊图标 + 组合效果
- 🔄 智能洗牌机制（无可用移动时自动洗牌）
- 📱 响应式布局（自适应屏幕）
- 🛡️ 完善的错误处理和恢复机制
- 📊 实时性能监控（FPS、内存）
- 🎵 模块化架构（易于扩展）
- 🧪 完整的测试覆盖（130个测试用例）

## 🔧 技术实现亮点

### 1. 模块化架构
- 事件驱动设计（EventBus）
- 清晰的模块划分（core、game、rendering、animation、utils）
- 松耦合、高内聚

### 2. 性能优化
- 对象池优化（补间动画、粒子系统）
- 纹理缓存机制
- 智能匹配检测（缓存 + 提前终止）
- 批量渲染优化

### 3. 错误处理
- 7种错误类型分类处理
- WebGL上下文丢失自动恢复
- 友好的错误提示UI
- 详细的错误日志记录

### 4. 测试覆盖
- 130个单元测试用例
- 11个集成测试用例
- 100%测试通过率
- 覆盖所有核心功能

### 5. 粒子效果系统
- 基于物理的粒子运动
- 对象池优化减少GC
- 多种视觉效果（爆炸、连锁、特殊图标）
- 可配置的粒子参数

## 🤝 贡献

欢迎提交 Issue 和 Pull Request！

## 📄 许可证

MIT License

## 📞 联系方式

如有问题或建议，请提交 Issue。

---

**当前版本**: v1.0.0 (项目已完成)  
**最后更新**: 2024

### 版本历史
- v1.0.0 - 项目完成（所有功能实现 + 测试完成 + 粒子效果）
- v0.8.0 - 第八阶段完成（粒子效果系统）
- v0.7.0 - 第七阶段完成（错误处理、性能监控、测试）
- v0.6.0 - 第六阶段完成（计时系统、特殊图标、洗牌）
- v0.5.0 - 第五阶段完成（UI系统、游戏循环、菜单功能）
- v0.4.0 - 第四阶段完成（动画系统）
- v0.3.0 - 第三阶段完成（游戏逻辑）
- v0.2.0 - 第二阶段完成（渲染引擎）
- v0.1.0 - 第一阶段完成（基础架构）

## 🎮 如何游玩

1. 启动开发服务器：`npm run dev`
2. 打开浏览器访问 http://localhost:5173
3. 点击"开始游戏"按钮开始游戏
4. 点击相邻的小鬼图标进行交换
5. 在60秒内获得尽可能高的分数！

### 游戏操作
- **鼠标点击**：选中和交换图标
- **ESC 键**：暂停/恢复游戏
- **暂停按钮**：点击顶部中央的暂停按钮
- **重新开始**：在暂停菜单或游戏结束界面点击"重新开始"

### 游戏规则
1. 点击一个小鬼图标进行选中（会显示高亮边框和脉冲动画）
2. 再点击相邻的小鬼图标进行交换
3. 形成三个或更多相同的小鬼连线即可消除
4. 消除后上方的小鬼会下落填充空位
5. 顶部会生成新的小鬼填充
6. 连续消除会触发连锁反应，获得更高分数
7. 在60秒内获得尽可能高的分数
8. 时间少于10秒时，计时器会变红色警告

### 分数计算示例
```
第1次消除：3个图标 = 30分 × 1.0 = 30分
第2次连锁：4个图标 = 40分 × 1.5 + 20 = 80分
第3次连锁：5个图标 = 50分 × 2.25 + 50 = 162分
特殊图标激活：额外 2-5 倍分数
总分：272分 + 特殊图标奖励
```

### 特殊图标玩法
- **4连匹配**：生成炸弹（消除周围3x3范围）
- **5连匹配**：生成彩色炸弹（消除所有同色图标）
- **L/T型匹配**：生成横向或纵向消除（消除整行/列）
- **特殊图标组合**：两个特殊图标交换产生超级效果

### 调试功能（可选）

在 `src/config.js` 中启用调试模式：

```javascript
debug: {
  enabled: true,      // 启用调试模式
  showFPS: true,      // 显示 FPS（右上角）
  showGrid: true,     // 显示网格
  logEvents: false    // 记录事件
}
```

启用后可以：
- 查看实时 FPS 和性能指标
- 在控制台查看详细的游戏日志
- 游戏结束时查看性能报告

## 📝 开发文档

项目的详细开发文档已整理到 `dev_docs/` 目录：

### 阶段完成报告 (`dev_docs/phases/`)
- `PHASE1_COMPLETE.md` - 第一阶段：基础架构和核心数据结构
- `PHASE2_COMPLETE.md` - 第二阶段：美术资源和渲染引擎
- `PHASE2_SUMMARY.md` - 第二阶段总结
- `PHASE3_COMPLETE.md` - 第三阶段：游戏循环和核心逻辑
- `PHASE3_SUMMARY.md` - 第三阶段总结
- `PHASE3_VERIFICATION.md` - 第三阶段验证清单
- `PHASE4_COMPLETE.md` - 第四阶段：动画系统
- `PHASE4_SUMMARY.md` - 第四阶段总结
- `PHASE4_VERIFICATION.md` - 第四阶段验证清单
- `PHASE5_COMPLETE.md` - 第五阶段：UI 和游戏循环
- `PHASE6_COMPLETE.md` - 第六阶段：计时系统和特殊图标
- `PHASE6_VERIFICATION.md` - 第六阶段验证清单
- `PHASE7_COMPLETE.md` - 第七阶段：优化和完善
- `PARTICLE_EFFECTS_COMPLETE.md` - 粒子效果系统完成总结

### Bug 修复记录 (`dev_docs/bug_fix/`)
- `BUG_FIX.md` - Bug 修复总记录
- `BUGFIX_ANIMATION.md` - 动画相关 Bug 修复
- `BUGFIX_PHASE2.md` - 第二阶段 Bug 修复
- `BUGFIX_PHASE4.md` - 第四阶段 Bug 修复
- 其他 Bug 修复文档

### 规格文档 (`.kiro/specs/ghost-match-game/`)
- `requirements.md` - 完整的需求文档（用户故事 + 验收标准）
- `design.md` - 详细的设计文档（架构、组件、数据模型）
- `tasks.md` - 实现任务清单（已全部完成）

