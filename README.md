# 👻 小鬼消消乐 - Ghost Match Game

一款基于 PixiJS v8.14.0 的浏览器消除类益智游戏。

## 🎮 游戏简介

小鬼消消乐是一款经典的三消游戏，玩家通过交换相邻的小鬼图标来形成三个或更多相同图标的连线，从而消除它们并获得分数。游戏采用模块化架构设计，使用 PixiJS 作为渲染引擎，确保代码解耦、可扩展且易于维护。

## ✨ 当前功能（第五阶段完成 + 第六阶段部分完成）

### 核心玩法
- ✅ 8x8 游戏板显示
- ✅ 5 种不同的小鬼图标
- ✅ 点击选中图标（高亮边框 + 脉冲动画）
- ✅ 点击相邻图标进行交换
- ✅ 自动检测匹配（3连或更多）
- ✅ 无匹配时自动交换回原位置
- ✅ 悬停效果
- ✅ 响应式布局（自适应不同屏幕尺寸）

### 游戏逻辑
- ✅ 完整的游戏状态管理（MENU、PLAYING、PAUSED、GAME_OVER、ANIMATING）
- ✅ 交换-匹配-消除-下落-填充循环
- ✅ 自动连锁反应检测
- ✅ 精确的分数计算系统
  - 基础分数：每个图标10分
  - 连锁倍数：1.5 ^ (comboCount - 1)
  - 4连额外20分，5连额外50分
- ✅ 图标自动下落填充
- ✅ 无可用移动检测（优化版本，带缓存）
- ✅ 游戏结束判定（时间到 / 无可用移动）

### 动画系统
- ✅ 轻量级补间动画系统（9种缓动函数）
- ✅ 交换动画（200ms, 平滑移动）
- ✅ 消除动画（300ms, 缩放 + 淡出）
- ✅ 下落动画（400ms, 模拟重力）
- ✅ 生成动画（200ms, 弹跳效果）
- ✅ 选中动画（循环脉冲）
- ✅ 连锁动画序列
- ✅ 60 FPS 流畅运行

### UI 系统 ✨ 新增
- ✅ 开始菜单（"小鬼消消乐"标题 + 开始按钮）
- ✅ 暂停菜单（继续游戏 / 重新开始）
- ✅ 游戏结束界面（最终分数 + 移动次数 + 重新开始）
- ✅ 实时分数显示（左上角）
- ✅ 倒计时器显示（右上角，<10秒红色警告）
- ✅ 移动次数显示（左上角下方）
- ✅ 暂停按钮（顶部中央，带悬停效果）
- ✅ FPS 显示（可选，调试模式）

### 游戏循环 ✨ 新增
- ✅ 基于 PixiJS Ticker 的游戏主循环
- ✅ 每帧更新动画和游戏逻辑
- ✅ 计时系统（默认60秒倒计时）
- ✅ 暂停/恢复功能（ESC 键或按钮）
- ✅ 重新开始功能
- ✅ 性能监控（FPS 显示）

### 控制台日志
- ✅ 交换请求日志
- ✅ 匹配检测结果
- ✅ 分数更新信息
- ✅ 连锁反应日志
- ✅ 游戏板稳定提示
- ✅ 状态变化日志
- ✅ 游戏结束信息

## 🚀 快速开始

### 环境要求

- Node.js 18.x 或更高版本
- npm 或 yarn

### 安装依赖

```bash
npm install
```

### 启动开发服务器

```bash
npm run dev
```

访问 http://localhost:5173 即可开始游戏。

### 构建生产版本

```bash
npm run build
```

构建结果将输出到 `dist` 目录。

### 预览生产版本

```bash
npm run preview
```

## 🎨 美术资源

### SVG 转 PNG

游戏使用 SVG 作为源文件，通过 sharp 库自动转换为 PNG：

```bash
npm run build:assets
```

这将扫描 `assets/svg/` 目录下的所有 SVG 文件，并转换为 128x128 的 PNG 文件，保存到 `assets/images/` 目录。

### 图标列表

**普通小鬼图标**:
- 红色小鬼 (ghost-red)
- 蓝色小鬼 (ghost-blue)
- 黄色小鬼 (ghost-yellow)
- 绿色小鬼 (ghost-green)
- 紫色小鬼 (ghost-purple)

**特殊图标**（待实现）:
- 炸弹 (bomb)
- 彩色炸弹 (color-bomb)
- 横向消除 (row-clear)
- 纵向消除 (col-clear)

## 🧪 测试

### 运行单元测试

```bash
npm test
```

### 监听模式

```bash
npm run test:watch
```

### 测试覆盖率

当前测试覆盖率：
- EventBus: 100% (8/8 测试通过)
- BoardManager: 100% (9/9 测试通过)
- MatchDetector: 100% (8/8 测试通过)
- GameEngine: 100% (7/7 测试通过) ✨ 新增
- StateManager: 100% (9/9 测试通过) ✨ 新增
- 总计: 41/41 测试通过 ✅

## 📁 项目结构

```
ghost-match-game/
├── index.html              # 游戏入口页面
├── package.json            # 项目配置
├── vite.config.js          # Vite 配置
├── README.md               # 项目说明
├── scripts/
│   └── convert-svg.js      # SVG 转 PNG 脚本
├── src/
│   ├── main.js            # 游戏主入口
│   ├── config.js          # 游戏配置
│   ├── core/
│   │   ├── EventBus.js    # 事件总线
│   │   ├── StateManager.js # 状态管理器
│   │   └── GameEngine.js  # 游戏引擎
│   ├── game/
│   │   ├── Tile.js        # 图标类
│   │   ├── BoardManager.js # 游戏板管理器
│   │   └── MatchDetector.js # 匹配检测器
│   ├── rendering/
│   │   ├── RenderEngine.js        # 渲染引擎
│   │   └── TileTextureFactory.js  # 纹理工厂
│   ├── input/
│   │   └── InputManager.js        # 输入管理器
│   ├── animation/         # 动画模块 ✨ 新增
│   │   ├── Easing.js      # 缓动函数
│   │   ├── Tween.js       # 补间动画类
│   │   └── AnimationController.js # 动画控制器
│   └── utils/             # 工具模块（待实现）
├── assets/
│   ├── svg/               # SVG 源文件
│   │   ├── ghosts/       # 普通小鬼图标 SVG
│   │   └── special/      # 特殊图标 SVG
│   └── images/            # PNG 资源
│       ├── ghosts/       # 普通小鬼图标 PNG
│       └── special/      # 特殊图标 PNG
└── tests/
    └── unit/
        ├── EventBus.test.js
        ├── BoardManager.test.js
        ├── MatchDetector.test.js
        ├── GameEngine.test.js    ✨ 新增
        └── StateManager.test.js  ✨ 新增
```

## 🛠️ 技术栈

- **渲染引擎**: PixiJS v8.14.0
- **开发工具**: Vite v5.0
- **包管理**: npm
- **图像处理**: sharp v0.33.0
- **测试框架**: Node.js 内置 test runner
- **编程语言**: JavaScript (ES6+ Modules)

## 📋 开发计划

### ✅ 第一阶段：基础架构和核心数据结构
- ✅ 项目结构和配置
- ✅ 事件总线系统
- ✅ 图标和游戏板数据结构
- ✅ 匹配检测算法

### ✅ 第二阶段：美术资源准备和 PixiJS 渲染引擎
- ✅ 设计和生成图标资源
- ✅ 实现 PixiJS 渲染引擎基础
- ✅ 实现图标纹理加载和精灵系统
- ✅ 实现输入管理器

### ✅ 第三阶段：游戏循环和核心逻辑
- ✅ 实现状态管理器
- ✅ 实现游戏引擎核心逻辑
- ✅ 实现消除和分数系统
- ✅ 实现下落和填充机制

### ✅ 第四阶段：动画系统
- ✅ 实现补间动画系统
- ✅ 实现动画控制器
- ✅ 集成动画到游戏流程

### ✅ 第五阶段：UI 和游戏循环
- ✅ 实现游戏主循环（基于 PixiJS Ticker）
- ✅ 实现 UI 渲染（分数、计时器、移动次数、按钮）
- ✅ 实现菜单和暂停功能（开始菜单、暂停菜单、ESC 键）

### ⏳ 第六阶段：计时系统和特殊图标（部分完成）
- ✅ 实现计时系统（60秒倒计时，<10秒红色警告）
- ⏳ 实现特殊图标系统（待实现）
- ⏳ 实现可用移动检测和洗牌（检测已完成，洗牌待实现）
- ✅ 实现游戏结束界面（时间到 / 无可用移动）
- ✅ 实现响应式布局（自适应屏幕尺寸）

### ⏳ 第七阶段：优化和完善
- ⏳ 实现错误处理
- ⏳ 实现性能监控和优化
- ⏳ 编写单元测试
- ⏳ 编写集成测试

### ⏳ 第八阶段：测试和打磨
- ⏳ 游戏平衡性调整
- ⏳ 添加音效和粒子效果
- ⏳ 多轮游戏测试

## 🎯 游戏特色

- 🎨 基于 PixiJS v8.14.0 的高性能渲染
- 🎬 流畅的动画系统（60 FPS）
- 🎮 完整的游戏循环和状态管理
- ⏱️ 60秒倒计时挑战模式
- 🔥 连锁反应系统（分数倍增）
- 📱 响应式布局（自适应屏幕）
- 🎵 模块化架构（易于扩展）
- 🧪 完整的单元测试覆盖

## 🤝 贡献

欢迎提交 Issue 和 Pull Request！

## 📄 许可证

MIT License

## 📞 联系方式

如有问题或建议，请提交 Issue。

---

**当前版本**: v0.5.3 (第五阶段完成 + 第六阶段部分完成)  
**最后更新**: 2024

### 版本历史
- v0.5.3 - 第六阶段部分完成（计时系统、游戏结束界面、响应式布局）
- v0.5.0 - 第五阶段完成（UI系统、游戏循环、菜单功能）
- v0.4.0 - 第四阶段完成（动画系统）
- v0.3.0 - 第三阶段完成（游戏逻辑）
- v0.2.0 - 第二阶段完成（渲染引擎）
- v0.1.0 - 第一阶段完成（基础架构）

## 🎮 如何游玩

1. 启动开发服务器：`npm run dev`
2. 打开浏览器访问 http://localhost:5173
3. 点击"开始游戏"按钮开始游戏
4. 点击相邻的小鬼图标进行交换
5. 在60秒内获得尽可能高的分数！

### 游戏操作
- **鼠标点击**：选中和交换图标
- **ESC 键**：暂停/恢复游戏
- **暂停按钮**：点击顶部中央的暂停按钮
- **重新开始**：在暂停菜单或游戏结束界面点击"重新开始"

### 游戏规则
1. 点击一个小鬼图标进行选中（会显示高亮边框和脉冲动画）
2. 再点击相邻的小鬼图标进行交换
3. 形成三个或更多相同的小鬼连线即可消除
4. 消除后上方的小鬼会下落填充空位
5. 顶部会生成新的小鬼填充
6. 连续消除会触发连锁反应，获得更高分数
7. 在60秒内获得尽可能高的分数
8. 时间少于10秒时，计时器会变红色警告

### 分数计算示例
```
第1次消除：3个图标 = 30分 × 1.0 = 30分
第2次连锁：4个图标 = 40分 × 1.5 + 20 = 80分
第3次连锁：5个图标 = 50分 × 2.25 + 50 = 162分
总分：272分
```

### 控制台日志（可选）
打开浏览器控制台（F12）可以查看详细的游戏日志：
- 交换请求和结果
- 匹配检测信息
- 分数更新（包括连锁倍数）
- 连锁反应日志
- 游戏板稳定提示
- 游戏结束信息

## 📝 开发文档

- `PHASE1_COMPLETE.md` - 第一阶段完成报告
- `PHASE2_COMPLETE.md` - 第二阶段完成报告
- `PHASE2_SUMMARY.md` - 第二阶段总结
- `PHASE3_COMPLETE.md` - 第三阶段完成报告
- `PHASE3_SUMMARY.md` - 第三阶段总结
- `PHASE3_VERIFICATION.md` - 第三阶段验证清单
- `PHASE4_COMPLETE.md` - 第四阶段完成报告
- `PHASE4_SUMMARY.md` - 第四阶段总结
- `PHASE4_VERIFICATION.md` - 第四阶段验证清单
- `PHASE5_COMPLETE.md` - 第五阶段完成报告 ✨ 新增
- `.kiro/specs/ghost-match-game/` - 完整的需求、设计和任务文档

