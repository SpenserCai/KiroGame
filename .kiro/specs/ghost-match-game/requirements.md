# 需求文档

## 简介

小鬼消消乐是一款基于 PixiJS v8.14.0 的浏览器消除类益智游戏。玩家通过交换相邻的小鬼图标来形成三个或更多相同图标的连线，从而消除它们并获得分数。游戏采用模块化架构设计，使用 PixiJS 作为渲染引擎，通过 npm 管理依赖，确保代码解耦、可扩展且易于维护。

**技术架构**：
- **运行环境**: 现代浏览器（游戏逻辑完全在浏览器端运行）
- **核心技术**: PixiJS v8.14.0 + 原生 JavaScript（ES6+ Modules）
- **开发工具**: Vite v5.0 + Node.js 18+（仅用于开发服务器和资源构建）
- **资源处理**: sharp v0.33.0（SVG转PNG）

Node.js 仅用于开发服务器和资源构建（SVG转PNG），游戏逻辑完全运行在浏览器端。

## 术语表

- **游戏系统 (Game System)**: 整个游戏应用的核心管理系统
- **游戏板 (Game Board)**: 显示小鬼图标的网格区域
- **小鬼图标 (Ghost Tile)**: 游戏中可消除的基本元素，使用 PixiJS Sprite 渲染
- **匹配 (Match)**: 三个或更多相同类型的小鬼图标形成的连线
- **交换 (Swap)**: 玩家交换两个相邻小鬼图标的操作
- **下落动画 (Fall Animation)**: 消除后小鬼图标向下移动的视觉效果，使用补间动画实现
- **渲染引擎 (Render Engine)**: 基于 PixiJS 的渲染模块，负责管理场景图和精灵
- **输入管理器 (Input Manager)**: 基于 PixiJS 事件系统处理用户鼠标/触摸输入的模块
- **状态管理器 (State Manager)**: 管理游戏不同状态（菜单、游戏中、暂停等）的模块
- **PixiJS Application**: PixiJS 的核心应用容器，管理渲染循环和场景图

## 需求

### 需求 1: 游戏初始化

**用户故事:** 作为玩家，我希望游戏能够正确初始化并显示游戏界面，以便我可以开始游戏。

#### 验收标准

1. WHEN 游戏系统启动时，THE 游戏系统 SHALL 创建一个8x8的游戏板网格
2. WHEN 游戏板创建时，THE 游戏系统 SHALL 随机填充5种不同类型的小鬼图标
3. WHEN 初始化完成时，THE 游戏系统 SHALL 确保游戏板上不存在任何初始匹配
4. WHEN 游戏界面加载时，THE 渲染引擎 SHALL 使用 PixiJS 创建并渲染完整的游戏板精灵
5. WHEN 游戏启动时，THE 游戏系统 SHALL 将分数初始化为0
6. WHEN PixiJS 资源加载时，THE 渲染引擎 SHALL 从 assets/images 目录加载所有图标纹理

### 需求 2: 小鬼图标交换

**用户故事:** 作为玩家，我希望能够通过点击交换相邻的小鬼图标，以便形成匹配并消除它们。

#### 验收标准

1. WHEN 玩家点击一个小鬼图标时，THE 输入管理器 SHALL 将该图标标记为已选中状态
2. WHEN 玩家点击第二个小鬼图标时，THE 游戏系统 SHALL 验证两个图标是否水平或垂直相邻
3. IF 两个图标相邻，THEN THE 游戏系统 SHALL 执行交换操作
4. IF 两个图标不相邻，THEN THE 游戏系统 SHALL 取消选中状态并提示玩家
5. WHEN 交换完成后不产生匹配时，THE 游戏系统 SHALL 在300毫秒内将图标交换回原位置

### 需求 3: 匹配检测与消除

**用户故事:** 作为玩家，我希望游戏能够自动检测并消除匹配的小鬼图标，以便我获得分数奖励。

#### 验收标准

1. WHEN 交换操作完成时，THE 游戏系统 SHALL 扫描整个游戏板检测水平和垂直方向的匹配
2. WHEN 检测到三个或更多相同类型的连续小鬼图标时，THE 游戏系统 SHALL 将它们标记为待消除
3. WHEN 小鬼图标被标记为待消除时，THE 渲染引擎 SHALL 播放消除动画效果
4. WHEN 消除动画完成时，THE 游戏系统 SHALL 从游戏板上移除这些小鬼图标
5. WHEN 小鬼图标被消除时，THE 游戏系统 SHALL 根据消除数量增加分数（每个图标10分）

### 需求 4: 下落与填充机制

**用户故事:** 作为玩家，我希望消除后的空位能够自动填充新的小鬼图标，以便游戏可以持续进行。

#### 验收标准

1. WHEN 小鬼图标被消除后，THE 游戏系统 SHALL 使上方的小鬼图标向下移动填充空位
2. WHEN 小鬼图标下落时，THE 渲染引擎 SHALL 播放平滑的下落动画
3. WHEN 顶部出现空位时，THE 游戏系统 SHALL 生成新的随机小鬼图标填充
4. WHEN 下落和填充完成后，THE 游戏系统 SHALL 再次检测是否产生新的匹配
5. WHILE 存在新的匹配时，THE 游戏系统 SHALL 自动触发连锁消除并增加额外分数

### 需求 5: 游戏状态管理

**用户故事:** 作为玩家，我希望游戏能够管理不同的游戏状态，以便我可以开始、暂停或重新开始游戏。

#### 验收标准

1. WHEN 游戏首次加载时，THE 状态管理器 SHALL 显示开始菜单界面
2. WHEN 玩家点击开始按钮时，THE 状态管理器 SHALL 切换到游戏进行状态
3. WHEN 游戏处于进行状态时，THE 输入管理器 SHALL 接受玩家的交换操作
4. WHEN 玩家按下暂停键时，THE 状态管理器 SHALL 暂停游戏并显示暂停菜单
5. WHEN 玩家选择重新开始时，THE 游戏系统 SHALL 重置游戏板和分数

### 需求 6: 视觉反馈与动画

**用户故事:** 作为玩家，我希望游戏提供流畅的视觉反馈，以便我能够清楚地看到游戏的变化。

#### 验收标准

1. WHEN 小鬼图标被选中时，THE 渲染引擎 SHALL 使用 PixiJS Graphics 显示高亮边框效果
2. WHEN 小鬼图标交换时，THE 动画控制器 SHALL 使用补间动画在200毫秒内平滑移动精灵位置
3. WHEN 小鬼图标被消除时，THE 动画控制器 SHALL 使用补间动画播放精灵的淡出和缩放效果
4. WHEN 小鬼图标下落时，THE 动画控制器 SHALL 使用缓动函数实现精灵的自然下落效果
5. WHEN 分数增加时，THE 渲染引擎 SHALL 使用 PixiJS Text 在界面上显示分数变化的动画提示

### 需求 7: 模块化架构

**用户故事:** 作为开发者，我希望代码采用模块化设计，以便系统易于维护和扩展。

#### 验收标准

1. THE 游戏系统 SHALL 将核心逻辑、渲染、输入处理和状态管理分离为独立 ES6 模块
2. THE 游戏系统 SHALL 使用事件系统实现模块间的松耦合通信
3. THE 游戏系统 SHALL 为每个模块定义清晰的接口和职责边界
4. THE 游戏系统 SHALL 支持通过配置文件调整游戏参数（网格大小、图标类型数量等）
5. THE 游戏系统 SHALL 允许在不修改核心代码的情况下添加新的小鬼图标类型
6. THE 游戏系统 SHALL 使用 npm 管理 PixiJS 等第三方依赖（pixi.js: ^8.14.0）
7. THE 游戏系统 SHALL 使用 ES6 模块系统（import/export）组织代码
8. THE 游戏系统 SHALL 提供 SVG 转 PNG 的自动化工具（使用 sharp 库）

### 需求 8: 性能与响应

**用户故事:** 作为玩家，我希望游戏运行流畅，以便获得良好的游戏体验。

#### 验收标准

1. THE 渲染引擎 SHALL 使用 PixiJS Ticker 保持至少60帧每秒的渲染性能
2. WHEN 玩家执行交换操作时，THE 游戏系统 SHALL 在50毫秒内响应
3. THE 游戏系统 SHALL 使用 PixiJS Ticker（基于 requestAnimationFrame）实现平滑的游戏循环
4. THE 渲染引擎 SHALL 利用 PixiJS 的自动渲染优化，仅在场景图变化时重绘
5. THE 游戏系统 SHALL 优化匹配检测算法以在5毫秒内完成扫描（8x8棋盘）
6. THE 游戏系统 SHALL 限制并发动画数量（最多20个）以保证性能
7. THE 游戏系统 SHALL 使用纹理复用和精灵池优化内存使用（目标<100MB）

### 需求 9: 用户界面

**用户故事:** 作为玩家，我希望看到清晰的游戏信息显示，以便了解当前游戏状态。

#### 验收标准

1. THE 渲染引擎 SHALL 使用 PixiJS Text 在游戏界面顶部显示当前分数
2. THE 渲染引擎 SHALL 使用 PixiJS Graphics 和 Text 创建交互式按钮（开始、暂停、重新开始）
3. WHEN 无法进行有效移动时，THE 游戏系统 SHALL 使用 PixiJS Text 显示"无可用移动"提示
4. THE 渲染引擎 SHALL 使用 PNG 纹理和清晰可辨的颜色区分不同类型的小鬼图标
5. THE 渲染引擎 SHALL 监听窗口 resize 事件，动态调整 PixiJS 应用大小以适应不同屏幕

### 需求 10: 计时系统

**用户故事:** 作为玩家，我希望游戏有时间限制，以便挑战自己在限定时间内获得最高分数。

#### 验收标准

1. WHEN 游戏开始时，THE 游戏系统 SHALL 启动倒计时器（默认60秒）
2. WHEN 计时器运行时，THE 渲染引擎 SHALL 在界面上实时显示剩余时间
3. WHEN 剩余时间少于10秒时，THE 渲染引擎 SHALL 以红色高亮显示时间并播放警告动画
4. WHEN 时间归零时，THE 游戏系统 SHALL 触发游戏结束状态
5. WHEN 游戏结束时，THE 状态管理器 SHALL 显示最终分数、游戏时长和重新开始选项
6. WHEN 游戏暂停时，THE 游戏系统 SHALL 暂停计时器
7. WHEN 游戏继续时，THE 游戏系统 SHALL 恢复计时器

### 需求 11: 特殊图标系统

**用户故事:** 作为玩家，我希望通过形成更长的匹配来创建特殊图标，以便获得更强大的消除效果和更高分数。

#### 验收标准

1. WHEN 玩家形成4个相同图标的匹配时，THE 游戏系统 SHALL 在匹配位置生成炸弹图标
2. WHEN 炸弹图标被消除时，THE 游戏系统 SHALL 消除周围3x3范围内的所有图标
3. WHEN 玩家形成5个相同图标的匹配时，THE 游戏系统 SHALL 在匹配位置生成彩色炸弹图标
4. WHEN 彩色炸弹被消除时，THE 游戏系统 SHALL 消除游戏板上所有与交换图标相同类型的图标
5. WHEN 玩家形成L型或T型匹配时，THE 游戏系统 SHALL 在交叉位置生成横向或纵向消除图标
6. WHEN 横向消除图标被激活时，THE 游戏系统 SHALL 消除整行图标
7. WHEN 纵向消除图标被激活时，THE 游戏系统 SHALL 消除整列图标
8. WHEN 特殊图标被消除时，THE 渲染引擎 SHALL 播放特殊的视觉效果和动画
9. WHEN 两个特殊图标交换时，THE 游戏系统 SHALL 触发组合效果（如炸弹+横向消除=3行消除）
10. WHEN 特殊图标产生消除时，THE 游戏系统 SHALL 给予额外分数奖励（基础分数的2-5倍）

### 需求 12: 无可用移动处理

**用户故事:** 作为玩家，我希望游戏能够检测无可用移动的情况并自动处理，以便游戏可以持续进行。

#### 验收标准

1. WHEN 下落和填充完成后，THE 游戏系统 SHALL 检测游戏板上是否存在可产生匹配的移动
2. IF 不存在任何有效移动，THEN THE 游戏系统 SHALL 在2秒后自动重新洗牌游戏板
3. WHEN 洗牌时，THE 渲染引擎 SHALL 显示"重新洗牌"提示动画
4. WHEN 重新洗牌时，THE 游戏系统 SHALL 保持当前分数和剩余时间不变
5. WHEN 洗牌完成后，THE 游戏系统 SHALL 确保游戏板上存在至少一个有效移动
